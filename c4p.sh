#!/usr/bin/env bash
# Install common pentester tools in containers as if they were native
#
# Copyright 2022 TheArqsz

SCRIPTPATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
TOOLS_DIR="$SCRIPTPATH/tools"
SCRIPTS_DIR="$SCRIPTPATH/scripts"


# Print usage of this script
help()
{
   echo "Usage: ./`basename "$0"` -t tool..."
   echo "Install common pentester tools in containers as if they were native"
   echo
   echo "Optional arguments:"
   echo "   -t, --tool        Tool to be installed (default: all)"
   echo "   -f, --force       Force install tool"
   echo "   -l, --list        List available tools"
   echo "   -v, --verbose     Set verbose mode"
   echo
}

# Print banner with the name of the script 
banner()
{
cat << EOF
   ___  _ _   ___ 
  / __|| | | | _ \\
 | (__ |_  _||  _/
  \___|  |_| |_|  
                                       
EOF
}

ctrl_c() {
	echo
	echo "Interrupting..."
	exit 1
}
trap ctrl_c INT

# Verify that necessary files exist
verify() {
    dir_to_check=$1
    files_in_dir=$(ls -1 $dir_to_check)
    if [ -f $dir_to_check/.skip ]; then
        echo "Skipping tool from $dir_to_check via .skip file"
        return 1
    fi
    if ! [ -f $dir_to_check/Dockerfile ]; then
        echo "Dockerfile doesn't exist in directory $dir_to_check. Skipping"
        return 1
    fi
    if ! [ -f $dir_to_check/test.sh ]; then
        echo "test.sh doesn't exist in directory $dir_to_check. Skipping"
        return 1
    fi
}

# Verify that specified tool is present in tools directory
verify_tool_exists() {
    if ! [ -d $TOOLS_DIR/$1 ]; then
        echo "Tool $1 doesn't exist - exiting"
        exit 1
    fi
}

# List available tools
list_tools () {
    echo "Available tools: "
    for tool in $(ls -1 $TOOLS_DIR/); do
        if [ "$tool" == "template" ]; then
            continue
        fi
        echo -e "\t $tool"
    done
}

tool_to_install="all"
force_install=0
force_fail_on_error=0

# Loop that sets arguments for the script
while [ -n "$1" ]; do 
	case "$1" in
	    -h|--help) 
         banner
         help
         exit;;
   	    -t|--tool)
         tool_to_install=$2
         verify_tool_exists $tool_to_install
         shift
         ;;
   	    -f|--force)
         force_install=1
         shift 0
         ;;
   	    --fail)
         force_fail_on_error=1
         shift 0
         ;;
   	    -l|--list)
         list_tools
         exit 0
         ;;
   	    -v|--verbose)
         set -x
         shift 0
         ;;
        *) 
         echo "Option '$1' is not recognized"
         echo
         help
         exit 1
         ;;
      esac
      shift
done

if [ -z "$tool_to_install" ]; then
   echo "Tool wasn't specified - installing all"
fi

if ! [ -f $HOME/.c4p_config ]; then
    touch $HOME/.c4p_config
fi

for current_tool in $(ls -1 $TOOLS_DIR/); do
    current_tool_path="$TOOLS_DIR/$current_tool"
    if ! verify "$current_tool_path"; then
        continue
    fi
    if [ "$tool_to_install" != "all" ] && [ "$tool_to_install" != "$current_tool" ]; then
        echo "Skipping installation of tool $current_tool"
        continue
    fi
    bash $current_tool_path/test.sh 1 2>/dev/null
    if [ $? -eq 0 ] && [ $force_install -eq 0 ]; then
        echo "Tool $current_tool already installed - skipping"
        continue
    else
        echo "Tool $current_tool is not installed or is forced to be reinstalled - installing"
    fi
    bash $SCRIPTS_DIR/install.sh $current_tool
    bash $current_tool_path/test.sh 2>/dev/null
    test_status=$?
    if [ $test_status -eq 1 ] && [ $force_fail_on_error -eq 0 ]; then
        continue
    elif [ $test_status -eq 1 ] && [ $force_fail_on_error -eq 1 ]; then
        echo "Tool $current_tool failed to be installed - exiting"
        exit 1
    elif [ $test_status -eq 0 ]; then
        echo "Tool $current_tool successfully installed."
    fi
done

if ! grep ". $HOME/.c4p_config" "$HOME/.bashrc" &>/dev/null; then
    echo ". $HOME/.c4p_config" >> $HOME/.bashrc
fi