#!/usr/bin/env bash

LIB_PATH="$( cd -- "$( dirname -- "${BASH_SOURCE[0]:-$0}"; )" &> /dev/null && pwd 2> /dev/null; )"
ALL_TOOLS_PATH="$(dirname $LIB_PATH)/tools"
CURRENT_TOOL=$1
CONTAINER_IMAGE=containers4pentesters/$CURRENT_TOOL:latest
NO_CONFIG_FILE=${2:-0}
FORCE_INSTALL=${3:-0}

if [ -z $CURRENT_TOOL ]; then
    echo "Tool not specified. Pass it as an argument."
    exit 1
fi

CURRENT_TOOL_PATH="$ALL_TOOLS_PATH/$CURRENT_TOOL"

if ! [ -d $CURRENT_TOOL_PATH ]; then
    echo "Tool $CURRENT_TOOL doesn't exist - exiting"
    exit 1
fi

source "$LIB_PATH/logging.sh"

terminate() {
    echo
	echo "Terminating installation..."
    if ! [ -z "${C4P_BACKGROUND_PROCESS_PID}" ]; then
        kill -9 "$C4P_BACKGROUND_PROCESS_PID"
    fi
	exit 1
}
trap terminate SIGINT
trap terminate INT

cleanup() {
    if [ -f "docker-$CURRENT_TOOL.logs" ]; then
        log_debug "Moving logs docker-$CURRENT_TOOL.logs to /tmp/c4p.docker-$CURRENT_TOOL.logs"
        mv -f docker-$CURRENT_TOOL.logs /tmp/c4p.docker-$CURRENT_TOOL.logs 
    fi
    unset C4P_BACKGROUND_PROCESS_PID

}
trap cleanup EXIT

if [ "$FORCE_INSTALL" -eq "1" ]; then
    CACHE_COMMAND="--no-cache"
else
    CACHE_COMMAND=
fi

docker build --force-rm $CACHE_COMMAND \
    -t $CONTAINER_IMAGE -f $CURRENT_TOOL_PATH/Dockerfile \
    --progress=plain $CURRENT_TOOL_PATH > docker-$CURRENT_TOOL.logs &

docker_build_pid="$!"

export C4P_BACKGROUND_PROCESS_PID=$docker_build_pid

wait_for_process_to_end "$docker_build_pid"

if [ -z "$NO_CONFIG_FILE" ] || [ "$NO_CONFIG_FILE" -eq "0" ]; then
    # If config file exists and tool is not there, add it
    if ! grep "$CURRENT_TOOL()" $HOME/.c4p_config &>/dev/null; then
        cat >> $HOME/.c4p_config << EOM
$CURRENT_TOOL() {
    $LIB_PATH/run.sh $CURRENT_TOOL "\$@"
}

EOM
    # If config file exists and tool is there, but the user forces reinstallation, add it once more
    elif grep "$CURRENT_TOOL()" $HOME/.c4p_config &>/dev/null && [ "$FORCE_INSTALL" -eq "1" ]; then
        perl -i -p0e "s;$CURRENT_TOOL\(.*\{\n.*\n\};$CURRENT_TOOL() {\n    $LIB_PATH/run.sh $CURRENT_TOOL \"\\$\@\"\n\};" /home/arek/.c4p_config
    fi
fi