#!/usr/bin/env bash

LIB_PATH="$( cd -- "$( dirname -- "${BASH_SOURCE[0]:-$0}"; )" &> /dev/null && pwd 2> /dev/null; )"
ALL_TOOLS_PATH="$(dirname $LIB_PATH)/tools"
CURRENT_TOOL=$1
source "$LIB_PATH/logging.sh"

if [ -z $CURRENT_TOOL ]; then
    echo "Tool not specified. Pass it as an argument."
    exit 1
fi

CURRENT_TOOL_PATH="$ALL_TOOLS_PATH/$CURRENT_TOOL"

if ! [ -d $CURRENT_TOOL_PATH ]; then
    echo "Tool $CURRENT_TOOL doesn't exist - exiting"
    exit 1
fi

CONTAINER_RUNTIME=${CONTAINER_RUNTIME:-docker}
CONTAINER_NAME=c4p-$CURRENT_TOOL
CONTAINER_IMAGE=c4p/$CURRENT_TOOL:latest
HOME=${HOME:-/tmp}
DOCKER_NETWORK_TYPE=${DOCKER_NETWORK_TYPE:-host}

if [ -f "$CURRENT_TOOL_PATH/pre-run.sh" ]; then
    . "$CURRENT_TOOL_PATH/pre-run.sh"
fi

if [ "$DEBIAN_FRONTEND" = "noninteractive" ]; then
    $CONTAINER_RUNTIME run \
        -i --rm --name $CONTAINER_NAME \
        --network $DOCKER_NETWORK_TYPE \
        --user `id -u`:`id -g` \
        --volume "$HOME":"$HOME" \
        --volume /tmp:/tmp \
        --volume /dev:/dev \
        -e HOME=$HOME \
        $DOCKER_OPTIONS $CONTAINER_IMAGE "${@:2}"
else
    $CONTAINER_RUNTIME run \
        -it --rm --name $CONTAINER_NAME \
        --network $DOCKER_NETWORK_TYPE \
        --user `id -u`:`id -g` \
        --volume "$HOME":"$HOME" \
        --volume /tmp:/tmp \
        --volume /dev:/dev \
        -e HOME="$HOME" \
        -e TERM=$TERM \
        $DOCKER_OPTIONS $CONTAINER_IMAGE "${@:2}"
fi