#!/usr/bin/env bash

SCRIPTS_PATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
ALL_TOOLS_PATH="$(dirname $SCRIPTS_PATH)/tools"
CURRENT_TOOL=$1
CONTAINER_IMAGE=c4p/$CURRENT_TOOL:latest

if [ -z $CURRENT_TOOL ]; then
    echo "Tool not specified. Pass it as an argument."
    exit 1
fi

CURRENT_TOOL_PATH="$ALL_TOOLS_PATH/$CURRENT_TOOL"

if ! [ -d $CURRENT_TOOL_PATH ]; then
    echo "Tool $CURRENT_TOOL doesn't exist - exiting"
    exit 1
fi

docker build --force-rm \
    -t $CONTAINER_IMAGE -f $CURRENT_TOOL_PATH/Dockerfile $CURRENT_TOOL_PATH

if ! grep "$CURRENT_TOOL()" $HOME/.c4p_config &>/dev/null; then
    cat >> $HOME/.c4p_config << EOM
$CURRENT_TOOL() {
    $SCRIPTS_PATH/run.sh $CURRENT_TOOL "\$@"
}

EOM
fi