FROM debian:bullseye-slim as build

ARG AIRCRACK_VERSION=1.7

ENV DEBIAN_FRONTEND=noninteractive
RUN apt update \
    && apt install -y \
        git build-essential autoconf automake \
        libpcap-dev libtool pkg-config \ 
        libnl-3-dev libnl-genl-3-dev libssl-dev \
        ethtool shtool rfkill zlib1g-dev \
        libpcap-dev libsqlite3-dev libpcre3-dev \
        libhwloc-dev libcmocka-dev hostapd \
        wpasupplicant tcpdump screen iw usbutils \
        net-tools kmod \
    && rm -rf /var/cache/apt/*

WORKDIR /src

RUN git clone --depth 1 --single-branch --branch ${AIRCRACK_VERSION} https://github.com/aircrack-ng/aircrack-ng

WORKDIR /src/aircrack-ng

RUN ./autogen.sh --enable-static --disable-shared && make && make install-strip

FROM gcr.io/distroless/cc

COPY --from=build /src/aircrack-ng /src/aircrack-ng
COPY --from=build /usr/local/sbin/airmon-ng /usr/local/sbin/airmon-ng
COPY --from=build /sbin/ifconfig /sbin/ifconfig
COPY --from=build /bin/grep /bin/grep
COPY --from=build /usr/lib/x86_64-linux-gnu/libsqlite3.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libhwloc.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libudev.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libcrypto.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libhwloc.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libudev.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /lib/x86_64-linux-gnu/libnl* /lib/x86_64-linux-gnu/
COPY --from=build /lib/x86_64-linux-gnu/libpcre.so* /lib/x86_64-linux-gnu/

ENTRYPOINT ["/src/aircrack-ng/airolib-ng"]