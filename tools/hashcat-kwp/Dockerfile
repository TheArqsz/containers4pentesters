FROM debian:bullseye-slim as build

ARG HASHCAT_VERSION=v6.2.5
ARG HASHCAT_UTILS_VERSION=v1.9
ARG HCXTOOLS_VERSION=6.2.5
ARG HCXDUMPTOOL_VERSION=6.2.5
ARG HCXKEYS_VERSION=master

ENV DEBIAN_FRONTEND=noninteractive
RUN apt update \
    && apt install -y \
        git build-essential autoconf automake \
        ocl-icd-libopencl1 clinfo pkg-config \
        libcurl4-openssl-dev libssl-dev zlib1g-dev libcurl4-openssl-dev libssl-dev \
    && rm -rf /var/cache/apt/*

WORKDIR /src

RUN git clone --depth 1 --single-branch --branch ${HASHCAT_VERSION} https://github.com/hashcat/hashcat

WORKDIR /src/hashcat

RUN make && make install -j4

WORKDIR /src

RUN git clone --depth 1 --single-branch --branch ${HASHCAT_UTILS_VERSION} https://github.com/hashcat/hashcat-utils.git

WORKDIR /src/hashcat-utils/src

RUN make

WORKDIR /src

RUN git clone --depth 1 --single-branch --branch ${HCXTOOLS_VERSION} https://github.com/ZerBea/hcxtools.git

WORKDIR /src/hcxtools

RUN make && make install

WORKDIR /src

RUN git clone --depth 1 --single-branch --branch ${HCXDUMPTOOL_VERSION} https://github.com/ZerBea/hcxdumptool.git

WORKDIR /src/hcxdumptool

RUN make && make install

WORKDIR /src

RUN git clone --depth 1 --single-branch --branch ${HCXKEYS_VERSION} https://github.com/hashcat/kwprocessor.git

WORKDIR /src/kwprocessor

RUN make

FROM gcr.io/distroless/base

COPY --from=build /usr/local/bin/hashcat /usr/local/bin/hashcat  
COPY --from=build /usr/local/share/doc/hashcat /usr/local/share/doc/hashcat
COPY --from=build /usr/local/share/hashcat /usr/local/share/hashcat

COPY --from=build /src/hashcat-utils/src/cap2hccapx.bin /usr/bin/cap2hccapx
COPY --from=build /usr/bin/hcx* /usr/bin/wlancap2wpasec /usr/bin/whoismac /usr/bin/
COPY --from=build /src/kwprocessor/kwp /usr/bin/kwp
# # COPY --from=build /sbin/ifconfig /sbin/ifconfig
# # COPY --from=build /bin/grep /bin/grep
# # COPY --from=build /usr/lib/x86_64-linux-gnu/libsqlite3.so* /usr/lib/x86_64-linux-gnu/
# # COPY --from=build /usr/lib/x86_64-linux-gnu/libhwloc.so* /usr/lib/x86_64-linux-gnu/
# # COPY --from=build /usr/lib/x86_64-linux-gnu/libudev.so* /usr/lib/x86_64-linux-gnu/
# # COPY --from=build /usr/lib/x86_64-linux-gnu/libcrypto.so* /usr/lib/x86_64-linux-gnu/
# # COPY --from=build /usr/lib/x86_64-linux-gnu/libhwloc.so* /usr/lib/x86_64-linux-gnu/
# # COPY --from=build /usr/lib/x86_64-linux-gnu/libudev.so* /usr/lib/x86_64-linux-gnu/
# # COPY --from=build /lib/x86_64-linux-gnu/libnl* /lib/x86_64-linux-gnu/
# # COPY --from=build /lib/x86_64-linux-gnu/libpcre.so* /lib/x86_64-linux-gnu/

ENTRYPOINT ["/usr/local/bin/hashcat"]