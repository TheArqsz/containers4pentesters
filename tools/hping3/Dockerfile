FROM ubuntu:18.04 as build

ENV DEBIAN_FRONTEND=noninteractive

RUN apt update \
    && apt install -y \
        libpcap-dev \
        git \
        autoconf \
        make \
        gcc \
        build-essential \
        tcl-dev \
        tcl \
        libtclcl1-dev \
    && rm -rf /var/cache/apt/*

RUN ln -s /usr/include/pcap/bpf.h /usr/include/net/bpf.h

WORKDIR /src

RUN git clone --depth 1 https://github.com/antirez/hping 

WORKDIR /src/hping

RUN ./configure && make && make install 

FROM gcr.io/distroless/base

COPY --from=build /usr/sbin/hping3 /usr/sbin/hping3
COPY --from=build /usr/lib/x86_64-linux-gnu/libpcap* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libtcl* /usr/lib/x86_64-linux-gnu/
COPY --from=build /lib/x86_64-linux-gnu/libz* /lib/x86_64-linux-gnu/
COPY --from=build /usr/share/tcltk /usr/share/tcltk

ENTRYPOINT ["/usr/sbin/hping3"]