FROM debian:bullseye-slim as build

ENV DEBIAN_FRONTEND=noninteractive
RUN apt update \
    && apt install -y \
        wget \
        build-essential \
        python3-dev \
        python3-venv \
        libssl-dev \
        cargo \
        unzip \
    && rm -rf /var/cache/apt/*

WORKDIR /src

ARG IMPACKET_VERSION=0_11_0

RUN wget https://github.com/fortra/impacket/archive/refs/tags/impacket_${IMPACKET_VERSION}.zip -O /src/impacket.zip && \
    unzip /src/impacket.zip && mv impacket-impacket_${IMPACKET_VERSION} impacket

RUN python3 -m venv /src/impacket/venv && \
    /src/impacket/venv/bin/pip install /src/impacket/ 

WORKDIR /src/impacket

FROM gcr.io/distroless/python3
LABEL org.opencontainers.image.authors="Arqsz"

COPY --from=build /src/impacket /src/impacket

ENV PATH="/src/impacket/venv/bin:$PATH"

ENTRYPOINT ["/src/impacket/venv/bin/smbserver.py"]