# Containerized impacket's smbserver

## Basic info

- **Current version**: 0.11.0
- **Source**: https://github.com/fortra/impacket/archive/refs/tags/impacket_0_11_0.zip

## Use indepentendly of the [containers4pentesters](https://github.com/TheArqsz/containers4pentesters) project

### CLI

Use in CLI directly as a pull from the DockerHub:

```bash
docker pull containers4pentesters/impacket-smbserver
docker run -it --rm --name impacket-smbserver \
        --user `id -u`:`id -g` \
        --volume "$HOME":"$HOME" \
        --volume "$(pwd)":"$(pwd)" \
        --volume /tmp:/tmp \
        -e HOME="$HOME" \
        -e TERM=$TERM \
        --network host containers4pentesters/impacket-smbserver \
            --help
```

or as a build (with [containers4pentesters](https://github.com/TheArqsz/containers4pentesters) repository cloned):

```bash
docker build -q -t containers4pentesters/impacket-smbserver:latest /opt/containers4pentesters/tools/impacket-smbserver/
docker run -it --rm --name impacket-smbserver \
        --user `id -u`:`id -g` \
        --volume "$HOME":"$HOME" \
        --volume "$(pwd)":"$(pwd)" \
        --volume /tmp:/tmp \
        -e HOME="$HOME" \
        -e TERM=$TERM \
        --network host containers4pentesters/impacket-smbserver:latest \
            --help
```

### As a script

You can create a script `/usr/local/bin/impacket-smbserver` with given content (pulling from the DockerHub):

```bash
#!/usr/bin/env bash

docker pull -q containers4pentesters/impacket-smbserver:latest
docker run -it --rm --name impacket-smbserver \
        --user `id -u`:`id -g` \
        --volume "$HOME":"$HOME" \
        --volume "$(pwd)":"$(pwd)" \
        --volume /tmp:/tmp \
        -e HOME="$HOME" \
        -e TERM=$TERM \
        --network host containers4pentesters/impacket-smbserver \
            "$@"
```

or as a build process (with [containers4pentesters](https://github.com/TheArqsz/containers4pentesters) repository cloned):

```bash
#!/usr/bin/env bash

docker build -q -t containers4pentesters/impacket-smbserver:latest /opt/containers4pentesters/tools/impacket-smbserver/
docker run -it --rm --name impacket-smbserver \
        --user `id -u`:`id -g` \
        --volume "$HOME":"$HOME" \
        --volume "$(pwd)":"$(pwd)" \
        --volume /tmp:/tmp \
        -e HOME="$HOME" \
        -e TERM=$TERM \
        --network host containers4pentesters/impacket-smbserver \
            "$@"
```

You can use the script as if it was a native tool

> This example assumes usage of port **445/tcp** (you need to have root rights)

*Server:*
```console
$ mkdir /tmp/smbserver-test
$ echo 1234 > /tmp/smbserver-test/myfile.txt
$ sudo su
$ id
uid=0(root) gid=0(root) groups=0(root)
$ /usr/local/bin/impacket-smbserver -smb2support -username user -password pass TMP /tmp/smbserver-test/
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Config file parsed
...
```

*Client:*
```console
$ smbclient //localhost/TMP --user user --password pass
Try "help" to get a list of possible commands.
smb: \> dir
  myfile.txt                         AN        5  xxx xxx  x xx:xx:xx 2024
```

## Known issues

### `Permission denied` when starting the smbserver

```python
Traceback (most recent call last):
  File "/src/impacket/venv/bin/smbserver.py", line 71, in <module>
    server = smbserver.SimpleSMBServer(listenAddress=options.interface_address, listenPort=int(options.port))
  File "/src/impacket/venv/lib/python3.9/site-packages/impacket/smbserver.py", line 4870, in __init__
    self.__server = SMBSERVER((listenAddress, listenPort), config_parser=self.__smbConfig)
  File "/src/impacket/venv/lib/python3.9/site-packages/impacket/smbserver.py", line 3965, in __init__
    socketserver.TCPServer.__init__(self, server_address, handler_class)
  File "/usr/lib/python3.9/socketserver.py", line 452, in __init__
    self.server_bind()
  File "/usr/lib/python3.9/socketserver.py", line 466, in server_bind
    self.socket.bind(self.server_address)
PermissionError: [Errno 13] Permission denied
```

This issue occurs because low privileged user has no rights to use TCP ports under 1024 (which 445 definitely is). By default, smbserver uses port 445/tcp.

There are 3 solutions:
- You can change the default port:
```console
$ impacket-smbserver -port 1445 TMP /tmp
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Config file parsed
```

- You should start the impacket-smbserver as a root user (it will use port 445/tcp):
```console
$ sudo su
$ impacket-smbserver TMP /tmp
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Config file parsed
```

> If you want to use it through c4p project, you can copy .c4p_config yourself or simply run the c4p installation one more time

- You can change docker's network type and the TCP port to a number above 1024:
```console
$ DOCKER_NETWORK_TYPE=bridge SMB_PORT=1445 impacket-smbserver TMP /tmp
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Config file parsed
```