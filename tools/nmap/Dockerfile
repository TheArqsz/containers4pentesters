FROM debian:bullseye-slim as build

ARG NMAP_VERSION=7.92

ENV DEBIAN_FRONTEND=noninteractive
RUN apt update \
    && apt install -y \
        ca-certificates \
        build-essential \
        wget \
        libssl-dev \ 
        autoconf \
    && rm -rf /var/cache/apt/*

RUN wget -O /tmp/nmap.tar.bz2 https://nmap.org/dist/nmap-${NMAP_VERSION}.tar.bz2 \
    && tar -xjf /tmp/nmap.tar.bz2 -C /tmp \
    && cd /tmp/nmap* \
    && ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --without-zenmap \
        --without-nmap-update \
        --with-openssl=/usr/lib \
        --with-liblua=/usr/include \
    && make \
    && make install


FROM gcr.io/distroless/base

COPY --from=build /usr/bin/nmap /usr/bin/nmap
COPY --from=build /usr/share/nmap /usr/share/nmap
COPY --from=build /usr/lib/x86_64-linux-gnu/libstdc++.so.6 /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libssl.so.1.1 /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1 /usr/lib/x86_64-linux-gnu/
COPY --from=build /lib/x86_64-linux-gnu/libgcc_s.so.1 /lib/x86_64-linux-gnu/

ENTRYPOINT ["/usr/bin/nmap"]