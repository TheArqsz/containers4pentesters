FROM python:3-slim as build

ENV DEBIAN_FRONTEND=noninteractive
RUN apt update \
    && apt install -y \
        git \
        python3 \
        python3-venv \
    && rm -rf /var/cache/apt/*

WORKDIR /src

ARG QARK_VERSION=4.0.0

RUN python3 -m venv /src/venv && \
    /src/venv/bin/pip install qark==${QARK_VERSION}

FROM python:3-alpine
LABEL org.opencontainers.image.authors="Arqsz"

COPY --from=build /src /src

RUN apk add --update --no-cache openjdk11

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1
ENV SITE_PACKAGE="/src/env/lib/python3.9/site-packages"
ENV PATH="/src/venv/bin:$PATH"

RUN mkdir /build && chmod a+rwx /build

ENTRYPOINT ["python", "/src/venv/bin/qark"]