FROM debian:bullseye-slim as build

ENV DEBIAN_FRONTEND=noninteractive
RUN apt update \
    && apt install -y \
        git build-essential libpcap-dev aircrack-ng pixiewps \
    && rm -rf /var/cache/apt/*

WORKDIR /src

ARG REAVER_VERSION=v1.6.6

RUN git clone --depth 1 --single-branch --branch ${REAVER_VERSION} https://github.com/t6x/reaver-wps-fork-t6x

WORKDIR /src/reaver-wps-fork-t6x/src

RUN ./configure && make && make install

FROM gcr.io/distroless/base

COPY --from=build /src/reaver-wps-fork-t6x/src /src/reaver
COPY --from=build /lib/x86_64-linux-gnu/libdbus-1.so* /lib/x86_64-linux-gnu/
COPY --from=build /lib/x86_64-linux-gnu/librt.so* /lib/x86_64-linux-gnu/
COPY --from=build /lib/x86_64-linux-gnu/liblzma.so* /lib/x86_64-linux-gnu/
COPY --from=build /lib/x86_64-linux-gnu/libgpg-error.so* /lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libsystemd.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libpcap.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libzstd.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/liblz4.so* /usr/lib/x86_64-linux-gnu/
COPY --from=build /usr/lib/x86_64-linux-gnu/libgcrypt.so* /usr/lib/x86_64-linux-gnu/

ENTRYPOINT ["/src/reaver/reaver"]