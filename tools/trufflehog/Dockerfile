ARG GO_VERSION=1.22.1-alpine

FROM golang:${GO_VERSION} AS build

RUN apk add --no-cache wget unzip
WORKDIR /src

ARG TRUFFLEHOG_VERSION=3.69.0

RUN wget -q -k https://github.com/trufflesecurity/trufflehog/archive/refs/tags/v${TRUFFLEHOG_VERSION}.zip && \
    unzip v${TRUFFLEHOG_VERSION}.zip && \
    rm v${TRUFFLEHOG_VERSION}.zip && \
    mv /src/trufflehog-${TRUFFLEHOG_VERSION} /src/trufflehog

WORKDIR /src/trufflehog

RUN CGO_ENABLED=0 go build -o /trufflehog .

FROM alpine:3.19
LABEL org.opencontainers.image.authors="Arqsz"
# Based on https://github.com/trufflesecurity/trufflehog/blob/main/Dockerfile

RUN apk add --no-cache bash git openssh-client ca-certificates rpm2cpio binutils cpio \
    && rm -rf /var/cache/apk/* && update-ca-certificates

COPY --from=build /trufflehog /usr/bin/trufflehog

ENTRYPOINT ["/usr/bin/trufflehog"]
CMD [ "--help" ]