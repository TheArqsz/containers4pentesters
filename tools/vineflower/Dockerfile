ARG GRADLE_VERSION=7.3.3-jdk17

FROM gradle:${GRADLE_VERSION} AS build

RUN apt update -yq \
    && apt install -yq \
        git \
    && rm -rf /var/cache/apt/*
WORKDIR /src

ARG VINEFLOWER_VERSION=master

RUN git clone --depth 1 --single-branch --branch ${VINEFLOWER_VERSION} https://github.com/Vineflower/vineflower

WORKDIR /src/vineflower 

RUN ./gradlew build

RUN cp build/libs/vineflower-*+local.jar build/libs/vineflower.jar

FROM gcr.io/distroless/java11-debian11
LABEL org.opencontainers.image.authors="Arqsz"

COPY --from=build /src/vineflower/build/libs/vineflower.jar /vineflower/

ENTRYPOINT ["java", "-jar", "/vineflower/vineflower.jar"]